# ğŸš€ ServiÃ§os n8n - Stack Docker Completo

Uma stack Docker Compose completa para automaÃ§Ã£o com n8n, incluindo monitoramento com Grafana, API WhatsApp com WAHA e cache Redis com interface visual, utilizando Caddy como proxy reverso.

## ğŸ“‹ Ãndice

- [VisÃ£o Geral](#-visÃ£o-geral)
- [ServiÃ§os IncluÃ­dos](#-serviÃ§os-incluÃ­dos)
- [PrÃ©-requisitos](#-prÃ©-requisitos)
- [InstalaÃ§Ã£o e ConfiguraÃ§Ã£o](#-instalaÃ§Ã£o-e-configuraÃ§Ã£o)
- [Uso](#-uso)
- [Estrutura do Projeto](#-estrutura-do-projeto)
- [ConfiguraÃ§Ãµes](#-configuraÃ§Ãµes)
- [Scripts UtilitÃ¡rios](#-scripts-utilitÃ¡rios)
- [Monitoramento](#-monitoramento)
- [Troubleshooting](#-troubleshooting)

## ğŸ¯ VisÃ£o Geral

Este projeto fornece uma stack completa de serviÃ§os Docker para automaÃ§Ã£o de processos usando n8n, com serviÃ§os complementares para monitoramento, comunicaÃ§Ã£o via WhatsApp e cache de dados, utilizando Caddy como proxy reverso moderno.

### CaracterÃ­sticas Principais

- ğŸ”§ **AutomaÃ§Ã£o**: Plataforma n8n para workflows
- ğŸ“Š **Monitoramento**: Grafana com dashboards personalizados
- ğŸ“± **WhatsApp API**: IntegraÃ§Ã£o completa com WAHA
- ğŸ—„ï¸ **Cache**: Redis Stack com interface RedisInsight
- ğŸš€ **Proxy Reverso**: Caddy com HTTPS automÃ¡tico
- ğŸ”’ **SeguranÃ§a**: SSL/TLS automÃ¡tico via Caddy
- ğŸ“ˆ **Performance**: ConfiguraÃ§Ãµes otimizadas de memÃ³ria
- ğŸŒ **Facilidade**: ConfiguraÃ§Ã£o simplificada

## ğŸ› ï¸ ServiÃ§os IncluÃ­dos

### 1. Caddy (Proxy Reverso)

- **Imagem**: `caddy:2.7-alpine`
- **Portas**: 80 (HTTP), 443 (HTTPS)
- **CaracterÃ­sticas**: HTTPS automÃ¡tico, configuraÃ§Ã£o simples
- **MemÃ³ria**: 128MB (limite), 64MB (reservado)

### 2. Grafana (Monitoramento)

- **Imagem**: `grafana/grafana:12.0.1`
- **Acesso**: `https://seu-dominio.com/grafana`
- **Recursos**: Dashboards de monitoramento, plugins Redis
- **MemÃ³ria**: 512MB (limite), 256MB (reservado)

### 3. WAHA (WhatsApp HTTP API)

- **Imagem**: `devlikeapro/waha:latest`
- **Acesso**: `https://seu-dominio.com/whatsapp`
- **Engine**: GOWS (Google Chrome Web Store)
- **Features**: API REST, Swagger UI, sessÃµes persistentes
- **MemÃ³ria**: 512MB (limite), 256MB (reservado)

### 4. Redis Stack

- **Imagem**: `redis/redis-stack:latest`
- **Acesso**: `https://seu-dominio.com/redis`
- **Features**: Cache, banco de dados, RedisInsight UI
- **MemÃ³ria**: 1GB (limite), 512MB (reservado)

## ğŸ“‹ PrÃ©-requisitos

- Docker Engine 20.10+
- Docker Compose V2
- DomÃ­nio configurado com DNS apontando para seu servidor
- Portas 80 e 443 abertas no firewall

### Criando a Rede Docker

```bash
docker network create n8n-services
```

### Criando Volumes Externos

```bash
docker volume create grafana_data
```

## ğŸš€ InstalaÃ§Ã£o e ConfiguraÃ§Ã£o

### 1. Clone o RepositÃ³rio

```bash
git clone <url-do-repositorio>
cd ServiÃ§os_n8n
```

### 2. Configurar VariÃ¡veis de Ambiente

```bash
# Copie o arquivo de exemplo
cp .env.example .env

# Edite as variÃ¡veis conforme necessÃ¡rio
nano .env
```

### 3. Configurar VariÃ¡veis ObrigatÃ³rias

Edite o arquivo `.env` com suas configuraÃ§Ãµes:

```bash
# DomÃ­nio principal
URL_SUBDOMAIN=seu-dominio.com

# Credenciais do Grafana
GRAFANA_ADMIN_USER=admin
GRAFANA_ADMIN_PASSWORD=SuaSenhaSegura123

# ConfiguraÃ§Ãµes WAHA
WAHA_API_KEY=sua-chave-api-waha
WAHA_SWAGGER_USERNAME=admin
WAHA_SWAGGER_PASSWORD=SuaSenhaWaha123

# Senha do Redis
REDIS_PASSWORD=SuaSenhaRedis123
```

### 4. Configurar o Caddyfile

Edite o arquivo `Caddyfile` e substitua `n8n.subdomÃ­nio.com` pelo seu domÃ­nio real:

```plaintext
seu-dominio.com {
    handle_path /grafana* {
        reverse_proxy grafana:3000
    }
    
    handle_path /whatsapp* {
        reverse_proxy waha:3000 {
            header_up X-Forwarded-Prefix /whatsapp
        }
    }
    
    handle_path /redis* {
        reverse_proxy redis-stack:8001
    }
}
```

### 5. Inicializar os ServiÃ§os

```bash
# Torna o script executÃ¡vel (Linux/Mac)
chmod +x init.sh
chmod +x restart.sh

# Execute o script de inicializaÃ§Ã£o
./init.sh
```

## ğŸ® Uso

### Iniciando os ServiÃ§os

```bash
# Usando Docker Compose
docker compose up -d

# Ou usando o script
./init.sh
```

### Parando os ServiÃ§os

```bash
# Usando Docker Compose
docker compose down

# Para remover volumes tambÃ©m
docker compose down -v
```

### Reiniciando os ServiÃ§os

```bash
# Usando o script utilitÃ¡rio
./restart.sh
```

### Verificando Status

```bash
# Ver status dos contÃªineres
docker compose ps

# Ver logs em tempo real
docker compose logs -f

# Ver logs de um serviÃ§o especÃ­fico
docker compose logs -f grafana
```

## ğŸ“ Estrutura do Projeto

```text
ServiÃ§os_n8n/
â”œâ”€â”€ compose.yml              # DefiniÃ§Ã£o dos serviÃ§os Docker
â”œâ”€â”€ Caddyfile               # ConfiguraÃ§Ã£o do proxy reverso Caddy
â”œâ”€â”€ .env.example            # Exemplo de variÃ¡veis de ambiente
â”œâ”€â”€ .env                    # Suas variÃ¡veis de ambiente (nÃ£o versionado)
â”œâ”€â”€ redis.conf              # ConfiguraÃ§Ãµes do Redis
â”œâ”€â”€ init.sh                 # Script de inicializaÃ§Ã£o
â”œâ”€â”€ restart.sh              # Script de reinicializaÃ§Ã£o
â”œâ”€â”€ README.MD               # Este arquivo
â””â”€â”€ data/                   # DiretÃ³rios de dados (criados automaticamente)
    â”œâ”€â”€ grafana/
    â”œâ”€â”€ waha/
    â””â”€â”€ redis/
```

## âš™ï¸ ConfiguraÃ§Ãµes

### Recursos Computacionais

Cada serviÃ§o estÃ¡ configurado com limites de recursos otimizados:

- **Caddy**: 128MB RAM, sem limite de CPU
- **Grafana**: 512MB RAM (limite), 256MB (reservado)
- **WAHA**: 512MB RAM (limite), 256MB (reservado)
- **Redis**: 1GB RAM (limite), 512MB (reservado)

### ConfiguraÃ§Ãµes do Redis

O arquivo `redis.conf` inclui:

- Limite de memÃ³ria: 512MB
- PolÃ­tica LRU para limpeza automÃ¡tica
- PersistÃªncia automÃ¡tica configurada
- CompressÃ£o de dados habilitada
- Backups automÃ¡ticos

### ConfiguraÃ§Ãµes do Caddy

O `Caddyfile` fornece:

- HTTPS automÃ¡tico com Let's Encrypt
- Roteamento baseado em path
- Headers customizados para aplicaÃ§Ãµes
- ConfiguraÃ§Ã£o simplificada
- RenovaÃ§Ã£o automÃ¡tica de certificados

### ConfiguraÃ§Ãµes de Rede

Todos os serviÃ§os utilizam a rede `n8n-services` e sÃ£o expostos via Caddy com:

- SSL/TLS automÃ¡tico
- Roteamento inteligente
- Headers de proxy apropriados
- Isolamento de rede

## ğŸ”§ Scripts UtilitÃ¡rios

### init.sh

Script de inicializaÃ§Ã£o que:

- Cria diretÃ³rios necessÃ¡rios automaticamente
- Inicia todos os serviÃ§os em modo daemon
- Aguarda a inicializaÃ§Ã£o dos serviÃ§os
- Verifica o status dos contÃªineres
- Exibe informaÃ§Ãµes Ãºteis para uso

### restart.sh

Script para reinicializaÃ§Ã£o rÃ¡pida que:

- Para todos os serviÃ§os graciosamente
- Reinicia em modo daemon
- Ãštil para aplicar mudanÃ§as de configuraÃ§Ã£o
- MantÃ©m dados persistentes

## ğŸ“Š Monitoramento

### Grafana

- **URL**: `https://seu-dominio.com/grafana`
- **Login**: Definido nas variÃ¡veis de ambiente
- **Plugins IncluÃ­dos**: Clock panel, Redis datasource
- **Dashboards**: DisponÃ­veis para criaÃ§Ã£o personalizada

### Redis Insight

- **URL**: `https://seu-dominio.com/redis`
- **Funcionalidades**:
  - VisualizaÃ§Ã£o de dados em tempo real
  - Monitoramento de performance
  - AnÃ¡lise de uso de memÃ³ria
  - Gerenciamento de chaves

### Logs Centralizados

```bash
# Ver todos os logs
docker compose logs -f

# Ver logs especÃ­ficos
docker compose logs -f caddy
docker compose logs -f grafana
docker compose logs -f waha
docker compose logs -f redis-stack

# Ver logs com timestamp
docker compose logs -f -t
```

## ğŸ› Troubleshooting

### Problema: ServiÃ§os nÃ£o iniciam

**SoluÃ§Ã£o**:

```bash
# Verificar logs detalhados
docker compose logs

# Verificar status da rede
docker network ls | grep n8n-services

# Recriar rede se necessÃ¡rio
docker network create n8n-services

# Verificar portas em uso
netstat -tlnp | grep -E ":(80|443)"
```

### Problema: HTTPS nÃ£o funciona

**SoluÃ§Ã£o**:

```bash
# Verificar logs do Caddy
docker compose logs caddy

# Verificar se o domÃ­nio aponta para o servidor
nslookup seu-dominio.com

# Verificar configuraÃ§Ã£o do Caddyfile
cat Caddyfile
```

### Problema: Erro de permissÃ£o

**SoluÃ§Ã£o**:

```bash
# Dar permissÃµes aos scripts
chmod +x init.sh restart.sh

# Verificar ownership dos diretÃ³rios de dados
sudo chown -R $USER:$USER ./data

# Verificar permissÃµes do Docker
sudo usermod -aG docker $USER
```

### Problema: VariÃ¡veis de ambiente nÃ£o carregadas

**SoluÃ§Ã£o**:

```bash
# Verificar se o arquivo .env existe
ls -la .env

# Validar sintaxe do arquivo .env
cat .env

# Verificar se as variÃ¡veis sÃ£o lidas
docker compose config
```

### Problema: Conflitos de porta

**SoluÃ§Ã£o**:

```bash
# Verificar portas em uso
sudo netstat -tlnp | grep -E ":(80|443|3000|6379|8001)"

# Parar serviÃ§os conflitantes
sudo systemctl stop apache2 nginx

# Verificar se hÃ¡ outros contÃªineres usando as portas
docker ps --format "table {{.Names}}\t{{.Ports}}"
```

### Problema: Erro de DNS/DomÃ­nio

**SoluÃ§Ã£o**:

```bash
# Verificar resoluÃ§Ã£o DNS
dig seu-dominio.com

# Testar conectividade
curl -I http://seu-dominio.com

# Verificar se o Caddy consegue resolver
docker compose exec caddy nslookup seu-dominio.com
```

## ğŸ“ URLs de Acesso

ApÃ³s a inicializaÃ§Ã£o completa, os serviÃ§os estarÃ£o disponÃ­veis em:

- **ğŸ  PÃ¡gina Principal**: `https://seu-dominio.com`
- **ğŸ“Š Grafana**: `https://seu-dominio.com/grafana`
- **ğŸ“± WAHA (WhatsApp API)**: `https://seu-dominio.com/whatsapp`
- **ğŸ—„ï¸ Redis Insight**: `https://seu-dominio.com/redis`
- **ğŸ“š Swagger WAHA**: `https://seu-dominio.com/whatsapp/swagger`

## ğŸ” SeguranÃ§a

### Boas PrÃ¡ticas Implementadas

- Senhas fortes obrigatÃ³rias via variÃ¡veis de ambiente
- HTTPS automÃ¡tico e forÃ§ado
- Isolamento de rede entre serviÃ§os
- Limites de recursos para prevenir DoS
- Volumes persistentes para dados importantes

### RecomendaÃ§Ãµes Adicionais

- Use senhas complexas (mÃ­nimo 12 caracteres)
- Mantenha as imagens Docker atualizadas
- Configure backup regular dos volumes
- Monitore logs regularmente
- Implemente firewall adicional se necessÃ¡rio

## ğŸ“š ReferÃªncias

- [DocumentaÃ§Ã£o do Caddy](https://caddyserver.com/docs/)
- [DocumentaÃ§Ã£o do Grafana](https://grafana.com/docs/)
- [DocumentaÃ§Ã£o do WAHA](https://waha.devlike.pro/)
- [DocumentaÃ§Ã£o do Redis Stack](https://redis.io/docs/stack/)
- [Docker Compose Reference](https://docs.docker.com/compose/compose-file/)
