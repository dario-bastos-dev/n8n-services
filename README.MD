# üöÄ Servi√ßos n8n - Stack Docker Completo

Uma stack Docker Compose completa para automa√ß√£o com n8n, incluindo monitoramento com Grafana e Prometheus, API WhatsApp com WAHA ou Evolution API e cache Redis com interface visual, utilizando Caddy como proxy reverso.

## üìã √çndice

- [Vis√£o Geral](#-vis√£o-geral)
- [Pr√©-requisitos](#-pr√©-requisitos)
- [Instala√ß√£o e Configura√ß√£o](#-instala√ß√£o-e-configura√ß√£o)
- [Uso](#-uso)
- [Estrutura do Projeto](#-estrutura-do-projeto)
- [Scripts Utilit√°rios](#-scripts-utilit√°rios)
- [Monitoramento](#-monitoramento)
- [Troubleshooting](#-troubleshooting)

## üéØ Vis√£o Geral

Este projeto fornece uma stack completa de servi√ßos Docker para automa√ß√£o de processos usando n8n, com servi√ßos complementares para monitoramento, comunica√ß√£o via WhatsApp e cache de dados, utilizando Caddy como proxy reverso moderno.

### Caracter√≠sticas Principais

- üîß **Automa√ß√£o**: Plataforma n8n para workflows
- üìä **Monitoramento**: Grafana com dashboards personalizados
- üì± **WhatsApp API**: Integra√ß√£o completa com WAHA
- üóÑÔ∏è **Cache**: Redis Stack com interface RedisInsight
- üöÄ **Proxy Reverso**: Caddy com HTTPS autom√°tico
- üîí **Seguran√ßa**: SSL/TLS autom√°tico via Caddy
- üìà **Performance**: Configura√ß√µes otimizadas de mem√≥ria
- üåê **Facilidade**: Configura√ß√£o simplificada

## üõ†Ô∏è Servi√ßos Inclu√≠dos

### 1. Caddy (Proxy Reverso)

- **Imagem**: `caddy:2.7-alpine`
- **Portas**: 80 (HTTP), 443 (HTTPS)
- **Caracter√≠sticas**: HTTPS autom√°tico, configura√ß√£o simples

### 2. Monitoramento

#### 2.1 Grafana

- **Imagem**: `grafana/grafana:12.0.1`
- **Acesso**: `https://grafana.services.subdom√≠nio.com`
- **Recursos**: Dashboards de monitoramento

#### 2.2 Prometheus

- **Imagem**: `prom/prometheus:v3.4.1`
- **Acesso**: `https://prometheus.services.subdom√≠nio.com`
- **Recursos**: recolhimento de m√©tricas

### 4. WhatsApp

#### 4.1 WAHA

- **Imagem**: `devlikeapro/waha:latest`
- **Acesso**: `https://waha.services.seu-dominio.com`

#### 4.2 Evolution API

- **Imagem**: `atendai/evolution-api:v2.1.1`
- **Acesso**: `https://evolution.services.seu-dominio.com`
- **Requisitos**: Precisa de um redis e um postgres.

### 5. Bancos de dados

#### 5.1 Redis Stack

- **Imagem**: `redis/redis-stack:latest`
- **Acesso**: `https://redis.services.subdom√≠nio.com`
- **Features**: Cache, banco de dados, RedisInsight UI

#### 5.2 Redis (Evo)

- **Imagem**: `redis:8-alpine`
- **Acesso**: Sem acesso web
- **Features**: Cache, banco de dados

#### 5.3 Postgres (Evo)

- **Imagem**: `postgres:17-alpine`
- **Acesso**: Sem acesso
- **Features**: Banco de dados

## üìã Pr√©-requisitos

- Docker Engine 20.10+
- Docker Compose V2
- Dom√≠nio configurado com DNS apontando para seu servidor
- Portas 80 e 443 abertas no firewall

## üöÄ Instala√ß√£o e Configura√ß√£o

### 1. Clone o Reposit√≥rio

```bash
git clone https://github.com/dario-bastos-dev/n8n-services.git
cd n8n-services
```

### 2. Configurar Vari√°veis de Ambiente

```bash
# Copie o arquivo de exemplo
cp .env.example .env

# Edite as vari√°veis conforme necess√°rio
nano .env
```

### 3. Configurar Vari√°veis Obrigat√≥rias

Edite o arquivo `.env` com suas configura√ß√µes:

```bash
# Dom√≠nio principal
# Subdom√≠nio da URL principal para os servi√ßos
URL_SUBDOMAIN=services.subdom√≠nio.com

# Configura√ß√µes do Grafana
GRAFANA_ADMIN_USER=admin
GRAFANA_ADMIN_PASSWORD=your_secure_password_here

# Configura√ß√µes do WAHA (WhatsApp HTTP API)
WAHA_SWAGGER_USERNAME=admin
WAHA_SWAGGER_PASSWORD=your_waha_swagger_password_here

# Configura√ß√µes do PostgreSQL para o Evolution API
POSTGRES_USER=your_postgres_user_here
POSTGRES_PASSWORD=your_postgres_password_here
POSTGRES_DB=your_postgres_database_here

# Configura√ß√µes do Evolution API
EVOLUTION_API_KEY=your_evolution_api_key_here

# Configura√ß√µes do Redis
REDIS_PASSWORD=your_redis_password_here
```

### 4. Configurar o Caddyfile

Edite o arquivo `Caddyfile` e substitua `nomeservico.services.subdom√≠nio.com` pelo seu dom√≠nio real:

```plaintext
nomeservico.services.subdom√≠nio.com {

    reverse_proxy nome-servico:porta

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        Referrer-Policy "no-referrer-when-downgrade"
        X-XSS-Protection "1; mode=block"
    }

    encode gzip zstd

}
```

### 5. Inicializar os Servi√ßos

```bash
# Torna o script execut√°vel (Linux/Mac)
chmod +x init.sh
chmod +x restart.sh

# Execute o script de inicializa√ß√£o
./init.sh
```

## üéÆ Uso

### Iniciando os Servi√ßos

```bash
# Usando Docker Compose
docker compose up -d

# Ou usando o script
./init.sh
```

### Parando os Servi√ßos

```bash
# Usando Docker Compose
docker compose down

# Para remover volumes tamb√©m
docker compose down -v
```

### Reiniciando os Servi√ßos

```bash
# Usando o script utilit√°rio
./restart.sh
```

### Verificando Status

```bash
# Ver status dos cont√™ineres
docker compose ps

# Ver logs em tempo real
docker compose logs -f

# Ver logs de um servi√ßo espec√≠fico
docker compose logs -f grafana
```

## üìÅ Estrutura do Projeto

```text
Servi√ßos_n8n/
‚îú‚îÄ‚îÄ compose.yml              # Defini√ß√£o dos servi√ßos Docker
‚îú‚îÄ‚îÄ Caddyfile               # Configura√ß√£o do proxy reverso Caddy
‚îú‚îÄ‚îÄ .env.example            # Exemplo de vari√°veis de ambiente
‚îú‚îÄ‚îÄ .env                    # Suas vari√°veis de ambiente (n√£o versionado)
‚îú‚îÄ‚îÄ redis.conf              # Configura√ß√µes do Redis
‚îú‚îÄ‚îÄ init.sh                 # Script de inicializa√ß√£o
‚îú‚îÄ‚îÄ restart.sh              # Script de reinicializa√ß√£o
‚îú‚îÄ‚îÄ README.MD               # Este arquivo
```

## ‚öôÔ∏è Configura√ß√µes

### Configura√ß√µes do Redis

O arquivo `redis.conf` inclui:

- Limite de mem√≥ria: 512MB
- Pol√≠tica LRU para limpeza autom√°tica
- Persist√™ncia autom√°tica configurada
- Compress√£o de dados habilitada
- Backups autom√°ticos

### Configura√ß√µes do Caddy

O `Caddyfile` fornece:

- HTTPS autom√°tico com Let's Encrypt
- Roteamento baseado em path
- Headers customizados para aplica√ß√µes
- Configura√ß√£o simplificada
- Renova√ß√£o autom√°tica de certificados

### Configura√ß√µes de Rede

Todos os servi√ßos utilizam a rede `n8n-services` e s√£o expostos via Caddy com:

- SSL/TLS autom√°tico
- Roteamento inteligente
- Headers de proxy apropriados
- Isolamento de rede

## üîß Scripts Utilit√°rios

### init.sh

Script de inicializa√ß√£o que:

- Cria diret√≥rios necess√°rios automaticamente
- Inicia todos os servi√ßos em modo daemon
- Aguarda a inicializa√ß√£o dos servi√ßos
- Verifica o status dos cont√™ineres
- Exibe informa√ß√µes √∫teis para uso

### restart.sh

Script para reinicializa√ß√£o r√°pida que:

- Para todos os servi√ßos graciosamente
- Reinicia em modo daemon
- √ötil para aplicar mudan√ßas de configura√ß√£o
- Mant√©m dados persistentes

## üìä Monitoramento

### Grafana

- **URL**: `grafana.services.subdom√≠nio.com`
- **Login**: Definido nas vari√°veis de ambiente
- **Plugins Inclu√≠dos**: Clock panel, Redis datasource
- **Dashboards**: Dispon√≠veis para cria√ß√£o personalizada

### Prometheus

- **URL**: `prometheus.services.subdom√≠nio.com`
- **Login**: Definido nas vari√°veis de ambiente
- **Metricas**: Defina os caminhos que ele pegar√° as m√©tricas em `./prometheus/prometheus.yml`

### Redis Insight

- **URL**: `redis.services.subdom√≠nio.com`
- **Funcionalidades**:
  - Visualiza√ß√£o de dados em tempo real
  - Monitoramento de performance
  - An√°lise de uso de mem√≥ria
  - Gerenciamento de chaves

### Logs Centralizados

```bash
# Ver todos os logs
docker compose logs -f

# Ver logs espec√≠ficos
docker compose logs -f caddy
docker compose logs -f grafana
docker compose logs -f prometheus
docker compose logs -f waha
docker compose logs -f redis-evo
docker compose logs -f postgres-evo
docker compose logs -f evolution-api
docker compose logs -f redis-stack

# Ver logs com timestamp
docker compose logs -f -t
```

## üêõ Troubleshooting

### Problema: Servi√ßos n√£o iniciam

**Solu√ß√£o**:

```bash
# Verificar logs detalhados
docker compose logs

# Verificar status da rede
docker network ls | grep n8n-services

# Recriar rede se necess√°rio
docker network create n8n-services

# Verificar portas em uso
netstat -tlnp | grep -E ":(80|443)"
```

### Problema: HTTPS n√£o funciona

**Solu√ß√£o**:

```bash
# Verificar logs do Caddy
docker compose logs caddy

# Verificar se o dom√≠nio aponta para o servidor
nslookup seu-dominio.com

# Verificar configura√ß√£o do Caddyfile
cat Caddyfile
```

### Problema: Erro de permiss√£o

**Solu√ß√£o**:

```bash
# Dar permiss√µes aos scripts
chmod +x init.sh restart.sh

# Verificar ownership dos diret√≥rios de dados
sudo chown -R $USER:$USER ./data

# Verificar permiss√µes do Docker
sudo usermod -aG docker $USER
```

### Problema: Vari√°veis de ambiente n√£o carregadas

**Solu√ß√£o**:

```bash
# Verificar se o arquivo .env existe
ls -la .env

# Validar sintaxe do arquivo .env
cat .env

# Verificar se as vari√°veis s√£o lidas
docker compose config
```

### Problema: Conflitos de porta

**Solu√ß√£o**:

```bash
# Verificar portas em uso
sudo netstat -tlnp | grep -E ":(80|443|3000|6379|8001)"

# Parar servi√ßos conflitantes
sudo systemctl stop apache2 nginx

# Verificar se h√° outros cont√™ineres usando as portas
docker ps --format "table {{.Names}}\t{{.Ports}}"
```

### Problema: Erro de DNS/Dom√≠nio

**Solu√ß√£o**:

```bash
# Verificar resolu√ß√£o DNS
dig seu-dominio.com

# Testar conectividade
curl -I http://seu-dominio.com

# Verificar se o Caddy consegue resolver
docker compose exec caddy nslookup seu-dominio.com
```

## üìù URLs de Acesso

Ap√≥s a inicializa√ß√£o completa, os servi√ßos estar√£o dispon√≠veis em:

`https://nome-servico.service.seudominio.com`

## üîê Seguran√ßa

### Boas Pr√°ticas Implementadas

- Senhas fortes obrigat√≥rias via vari√°veis de ambiente
- HTTPS autom√°tico e for√ßado
- Isolamento de rede entre servi√ßos
- Limites de recursos para prevenir DoS
- Volumes persistentes para dados importantes

### Recomenda√ß√µes Adicionais

- Use senhas complexas (m√≠nimo 12 caracteres)
- Mantenha as imagens Docker atualizadas
- Configure backup regular dos volumes
- Monitore logs regularmente
- Implemente firewall adicional se necess√°rio

## üìö Refer√™ncias

- [Documenta√ß√£o do Caddy](https://caddyserver.com/docs/)
- [Documenta√ß√£o do Grafana](https://grafana.com/docs/)
- [Documenta√ß√£o do Prometheus](https://prometheus.io/docs/introduction/overview/)
- [Documenta√ß√£o do Evolution API](https://doc.evolution-api.com/v2/pt/get-started/introduction)
- [Documenta√ß√£o do WAHA](https://waha.devlike.pro/)
- [Documenta√ß√£o do Redis Stack](https://redis.io/docs/stack/)
- [Docker Compose Reference](https://docs.docker.com/compose/compose-file/)
